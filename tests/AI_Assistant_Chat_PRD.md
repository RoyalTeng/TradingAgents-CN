# TradingAgents-CN AI 助手对话功能 — 产品需求文档（PRD，细化版）

文档版本：v1.0.0-refined  | 最近更新：2025-11-02  
产品负责人：TradingAgents-CN Team  | 文档状态：评审稿（细化）

---

## 0. 执行摘要（针对本期目标）

- 对话窗口内原位可视化（K 线/指标/净值曲线）
- 策略回测（内置引擎）：参数化、异步执行、指标与产物返回、对话内展示
- 个性化（用户画像/行为/模拟交易/回测摘要）：作为对话上下文输入，提升建议的贴合度

本期输出：前后端端到端最小可用能力（MVP），并留出扩展点接入 LLM 流水线、更多数据源与团队协作。

---

## 1. 产品概述

### 1.1 定位
在 TradingAgents-CN 现有量化分析系统基础上，新增“AI 助手对话”模块，统一承载股票分析、策略回测、研究报告与个性化建议，通过自然语言交互降低使用门槛。

### 1.2 目标与非目标
- 目标：
  - 一站式对话入口，串联行情/分析/回测/报告/个性化画像。
  - 对话内直接渲染可交互图表与表格；支持导出。
  - 内置回测引擎（快速信号 + 可选 LLM 信号），产物可复用。
  - 将用户画像（偏好/行为/模拟交易/回测摘要）注入对话，提高建议贴合度。
- 非目标（本期）：
  - 高频/毫秒级实盘交易撮合（仅模拟/研究级）。
  - 复杂跨市场多资产策略（留扩展点）。

### 1.3 典型用户与场景
- 个人投资者：提问“分析 600519，并给出近期买卖建议”，获取图表、指标与简明建议。
- 研究员/量化：发起“白酒板块多策略回测对比”，对话中查看指标卡与净值曲线，并下载产物。
- 顾问/团队：基于用户画像提供“符合其风险与持仓习惯”的建议，并生成分享快照。

---

## 2. 功能需求（细化）

### 2.1 对话交互界面
- 入口与导航（对齐现有前端体系）
  - 在现有应用的左侧侧边栏新增一级入口项“🤖 AI助手”，与“仪表板 / 股票分析 / 任务中心 / 股票筛选 / 我的自选股 / 模拟交易 / 设置 / 关于”等模块并列。
  - 选择“🤖 AI助手”后，主内容区域切换为 AI 对话页面（不跳转外部路由），保持现有头部/布局/主题一致，复用统一的认证与权限体系（permission: "analysis"）。
  - 页面标识：`ai_chat`（内部路由标记/埋点使用）；侧边栏高亮状态与其他模块一致。
  - 集成原则（重要）：严格“增量接入、零侵入”。不修改或重构现有页面/组件/样式/路由，只新增一个页面与一个侧边栏入口；所有样式仅作用于本页面作用域。
  - 侧边栏模块清单（统一）：
    - 仪表板 / 股票分析 / 任务中心 / 股票筛选 / 我的自选股 / 模拟交易 / 设置 / 关于 / 🤖 AI助手
- 消息形态：`text | chart | table | code | image | notice | error`；均包含时间戳、角色（user/assistant/system）。
- Markdown：表格、代码高亮、任务列表、脚注；图片支持 URL/base64；可选公式（开关）。
- 流式生成：assistant 回复分片展示，显示“生成中/中止/重试”。
- 消息操作：复制、重新生成、在此继续、标星、快照链接、导出（Markdown/PNG）。
- 输入区：多行输入（Shift+Enter 换行 / Enter 发送）、限 2,000 汉字（可配）；文件上传（CSV/Excel/JSON，≤10MB/个，≤5 个）。
  - 键盘行为（强约束）：Enter=发送；Shift+Enter=换行。发送后输入框清空并滚动至底部；失败时保留输入内容供重试。
- 智能补全：股票代码、日期/区间；模板（快捷入口，如“个股体检/板块对比/回测”）。
- 会话侧栏：搜索、重命名、归档/删除（软删 30 天）、最近上传与回测入口；“本会话启用个性化”单一开关（覆盖全局）。
  - 样式对齐：会话侧栏采用与系统左侧栏一致的字体/间距/按钮风格；组件不另起独立页，保持同一 Streamlit 页面内三栏布局（会话/对话/快捷）。
 - 快捷键：Ctrl/Cmd+K（模板）、Ctrl/Cmd+L（清空）、Esc（取消生成）。
- 体验指标：500ms 内出现“已发送”；10s 内首包（正常网络与可用模型）。

#### 2.1.A 界面示意图（ASCII，仅示意，不代表最终像素尺寸）

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                                头部（保持现有样式）                            │
└───────────────────────────────────────────────────────────────────────────────┘
┌───────────────┬───────────────────────────────────────────────┬──────────────┐
│  侧边栏（左）  │              主内容：🤖 AI 助手（中）            │   快捷（右）   │
│               │                                               │              │
│  ◻ 仪表板     │  ┌─────────────────────────────────────────┐  │  📈 热门股票   │
│  ◻ 股票分析   │  │  🤖 AI投资助手（标题/副标题）            │  │  - 贵州茅台    │
│  ◻ 任务中心   │  └─────────────────────────────────────────┘  │  - 宁德时代    │
│  ◻ 股票筛选   │                                               │  - 比亚迪      │
│  ◻ 我的自选股 │  ┌────── 对话历史（消息气泡） ──────────────┐  │  ...          │
│  ◻ 模拟交易   │  │ 👤 用户：分析贵州茅台                    │  │  ──────────── │
│  ◻ 设置       │  │ 🤖 助手：技术分析摘要…                   │  │  📊 市场概览   │
│  ◻ 关于       │  │ 🤖 助手：[K线图 | 净值曲线（Plotly）]    │  │  上证: 3,100   │
│  ● 🤖 AI助手   │  │ 🤖 助手：[回测指标表格]                 │  │  深证: 11,080  │
│               │  └─────────────────────────────────────────┘  │  创业板: 2,205 │
│  ───────────  │  ┌──────────── 输入区（底部固定） ──────────┐  │  ──────────── │
│  💬 会话       │  │  [💡模板1] [模板2] [模板3] [模板4]       │  │  ⚡ 常用功能   │
│  ➕ 新建会话   │  │  [多行输入…]           [🚀发送] [🗑清空] │  │  - 导出对话    │
│  📌 会话1 (5)  │  └─────────────────────────────────────────┘  │  - 查看统计    │
│  📝 会话2 (0)  │                                               │              │
│  …            │                                               │              │
│  ───────────  │  说明：消息类型 text/chart/table/code/error/  │              │
│  🎯 启用个性化  │        notice；图表交互缩放/悬停；输入支持   │              │
│  （会话级）    │        Shift+Enter换行。                     │              │
└───────────────┴───────────────────────────────────────────────┴──────────────┘
```


#### 2.1.1 布局与样式规范（与现有系统一致）

- 三栏布局
  - 左栏（会话）：280–320px，自适应（最小 260px），纵向可滚动
  - 中栏（对话）：弹性宽度，占比 60–70%，最小宽 640px
  - 右栏（快捷）：280–320px，自适应（最小 260px），纵向可滚动
  - 间距：统一采用 8px 栅格体系（外边距 16/24/32；内边距 8/12/16）

- 主题与排版
  - 字体族：Inter, -apple-system, "Microsoft YaHei"
  - 字号：H1=24/H2=20/H3=18/正文=14（px）
  - 颜色：主色 #667EEA、辅色 #764BA2、正文 #1F2937、弱化 #6B7280、边界 #E5E7EB
  - 气泡背景：用户 #E8F4F8（右）、助手 #F0F0F0（左），圆角 12px
  - 阴影：卡片与气泡 0 4px 6px rgba(0,0,0,0.08)

- 左栏（会话）
  - 头部：标题“💬 会话” + “➕ 新建会话”按钮（主色填充，圆角 8px）
  - 会话项：标题 + 消息数（弱化）；选中态浅主色背景；悬停高亮；点击切换
  - 会话内操作：重命名（内联）、删除（二次确认）、归档
  - 个性化开关：🎯 启用个性化（切换后立即生效，覆盖全局）

- 中栏（对话）
  - 消息气泡：最大宽 85%；Markdown 支持（表格/代码块/列表/链接）；时间戳置于右下角 caption（HH:mm:ss）
  - 消息类型：
    - text：Markdown 渲染
    - chart：Plotly 图（高度 320–400px，hovermode: x unified，隐藏 range slider）
    - table：DataFrame 渲染，列自动宽度，可滚动
    - code：语法高亮，复制按钮（可选）
    - error/notice：使用系统 error/info 样式
  - 输入区：多行文本域（默认 100–120px 高）+ 发送（主色）/清空（次要）；上方一行模板按钮（4 项）
  - 空/加载/错误：空态引导卡片；加载骨架屏；错误提供重试建议

- 右栏（快捷）
  - 热门股票：按钮列表（单列均匀铺满），点击注入模板
  - 市场概览：三大指数指标卡（涨绿/跌红）
  - 常用功能：导出对话（Markdown/JSON）与统计入口

- 响应式与可达性
  - 响应式：<1280px 可折叠右栏；<960px 仅展示中栏（会话/快捷通过抽屉切换）
  - 可达性：对比度达 WCAG AA；焦点 ring；Tab/Shift+Tab 可导航；aria-label 完整

- 图表默认配置
  - Plotly：template=plotly_white、hovermode=x unified、legend 右上角、边距 16px
  - K 线：成交量副轴 y2（右侧）；净值曲线：主色线宽 2px（可选回撤阴影）
  - 导出：右上工具栏允许保存为 PNG/JPEG，或后端 kaleido 导出

- 样式验收
  - 1440px 桌面下：左 300 / 中自适应 / 右 300，间距与字号符合规范
  - 长消息/表格/代码/图表不溢出容器；滚动条样式与主题一致
  - 模板/热门股票/市场概览可点击性明显；空/加载/错误状态提示明确

### 2.2 AI 助手能力
- 基本面：入参（代码、财报期、对比标的），出参（盈利/成长/估值区间、关键比率与来源日期、风险点）。
- 技术面：入参（周期、指标、窗口），出参（趋势/关键位、指标表、交易倾向、图表消息）。
- 行业对比：入参（行业或自选池，指标集），出参（排序表、可视化、投资建议）。
- 情绪/新闻：入参（主题/代码、时间范围），出参（情绪得分、要点摘要、影响评估与不确定性）。
- 策略建议：入参（目标收益/回撤、资金规模、风格），出参（开平仓建议、仓位/风控参数与证据）。
- 数据与工具：Tushare/AKShare/BaoStock/Finnhub 等统一访问，自动降级与缓存；失败清晰降级提示。
- 质量：所有结论附“证据链”（来源、时间戳、窗口）；支持“只看估值/只看技术”等聚焦追问路径。

### 2.3 对话与上下文管理
- 生命周期：自动命名（首条消息摘要）、重命名、归档/删除（软删 30 天）、导出（Markdown/JSON 含资源引用）。
- 上下文策略：保留 10~20 轮，对超限历史做自动摘要（保存关键信息、用户偏好与任务目标）。
- 记忆点：偏好行业/周期、风险偏好、常用指标、常用股票池、常问问题模板。
- 隐私：设置中允许关闭“记忆”或仅限会话级；导出/清除具备二次确认与撤回机制。
- 存储与缓存：Redis（热上下文）+ MongoDB（全文/索引）；旧会话定时压缩归档。

### 2.4 数据可视化（对话内嵌）
- 可视化消息协议（统一）：
```json
{
  "type": "chart",
  "lib": "plotly",           // 或 echarts / vega-lite
  "payload": { /* 图表配置 JSON：Plotly figure.to_plotly_json() 等 */ },
  "meta": { "title": "600519 K线", "height": 320, "downloadable": true }
}
```
- 典型图表：
  - K 线 + MA/成交量；技术指标副图（MACD/RSI 等）。
  - 回测净值曲线 + 回撤；财务指标对比（柱状/折线）。
- 交互细节：快捷区间（5D/1M/3M/6M/1Y/YTD/自定义）、指标勾选、叠加/副图切换、明暗主题一致。
- 降级策略：弱网/限制场景，后端导出静态 PNG（kaleido）并以 `type: image` 返回；提供 CSV/JSON 数据导出。
- 性能：单图 ≤ 10 万点，超限自动采样/分页加载；图像下载与页面样式一致。

### 2.5 策略回测（内置引擎）
- 参数：股票池、起止日期、初始资金、执行规则（next_open/next_close/vwap）、滑点/佣金/印花税、频率（日/分钟-分步）。
- 模式：
  - 快速信号（默认）：内置 MA 策略，无需 LLM，快速反馈与批量实验。
  - LLM 信号（可选）：接入 TradingAgents 多 Agent/LLM 流水线生成信号。
- 运行：异步任务（阶段：`fetch → signal → exec → metrics`）；支持重试与失败日志回溯；并发队列与限流。
- 产出：
  - 指标卡：总收益、年化、波动、夏普、最大回撤、胜率、盈亏比、交易天数。
  - 图表：净值曲线/回撤（对话内 chart 消息）。
  - 文件：`equity_curve.csv / trades.csv / metrics.json / report.md`（报告为 Markdown）。
- 多策略对比：同一会话内对比不同参数/信号源；对话中生成“对比表 + 可视化”。

### 2.6 个性化（画像与数据）
- 数据域：
  - 行为日志（已有，JSONL）：页面访问、分析、导出、配置修改等。
  - 模拟交易与回测：交易明细、组合快照、回测摘要与指标。
  - 用户画像：偏好（风险/期限/行业/指标）、习惯（平均持有、活跃时段、常用标的）、绩效（胜率/回撤）。
- 对话注入器（单一开关）：
  - personalization.enabled = true 时，默认注入“画像摘要 + 最近操作（N）+ 最近回测摘要（M）+ 近 30 日模拟持仓片段”。
  - personalization.enabled = false 时，不注入上述任何个人化上下文。
  - 细节按需拉取（工具函数），控制 token 成本与时延；尊重隐私设置；无细粒度授权项（暂不区分行为/回测/模拟交易/持仓）。
- 隐私与合规（单一授权）：
  - 仅提供一个“使用我的数据进行个性化”的总开关（默认策略由配置决定），无细粒度授权（不区分行为日志/回测摘要/模拟交易/持仓快照等）。
  - 一键“拒绝使用我的数据”与“撤回画像”；数据脱敏与留存周期；导出与删除权利（GDPR/本地合规参考）。

### 2.7 协作与分享
- 分享：对话快照（不可变，含时间戳与水印）、图表/报告分享链接（有效期/密码）。
- 团队：多人评论与标注、观点对齐、投票；权限（公开/团队/私有）。

---

## 3. 非功能需求

### 3.1 性能
- 响应：首次响应 < 2s；复杂分析 < 15s（流式）；表单/切换 < 100ms。
- 并发：≥ 100 并发用户；用户侧 QPS 10 次/分钟；系统 QPS ≥ 1,000/分钟。
- 回测：任务排队可视化；单回测在常见参数下 30~120s 完成（与数据量相关）。

### 3.2 可用性与稳定性
- 可用性 ≥ 99.9%；故障恢复 ≤ 1h；备份周期：每日。
- 超时与降级：多模型备援、消息重试、静态图降级、缓存命中反馈。

### 3.3 安全与隐私
- 传输层 TLS；数据面脱敏；日志级别控管；最小权限原则。
- 画像与历史数据的用户授权与可撤回；导出/删除与追踪记录。

### 3.4 兼容性
- 浏览器：Chrome 90+ / Firefox 88+ / Safari 14+ / Edge 90+。
- 设备：PC 完整功能；平板适配；移动端基础能力。

### 3.5 监控与观测
- 监控：API 延迟/错误率/队列长度；回测任务状态与耗时分布。
- 日志：结构化日志与关联 ID（会话 ID / 回测 job_id）。

---

## 4. 技术与接口（概要）

### 4.1 架构
```
前端层：Streamlit / Vue（侧边栏导航：仪表板/股票分析/任务中心/股票筛选/我的自选股/模拟交易/设置/关于/AI助手；
        消息组件 + 图表组件 + WebSocket）
API 网关：FastAPI（认证/限流/路由）
对话管理：会话/上下文/意图/响应生成
回测服务：任务调度/执行/产物归档
数据层：多源行情/财务/新闻；Redis 缓存；MongoDB/文件
```

### 4.2 数据与存储
- MongoDB
  - `chat_sessions`: 会话与消息（含元数据与摘要）
  - `backtest_runs`: 回测任务（参数、状态、进度、产物、指标）
  - `user_profiles`: 用户画像（偏好/习惯/绩效摘要）
  - `sim_trades`: 模拟交易与组合快照
- Redis
  - `session:{id}:context`（TTL 1h）
  - `stock:{code}:realtime`（TTL 1m）、`stock:{code}:daily`（TTL 1d）
- 文件系统
  - 回测产物（CSV/JSON/MD/PNG）；日志与缓存

### 4.3 API 契约（关键）
- 对话（REST）
  - `POST /api/v1/chat/sessions` → `{ session_id }`
  - `POST /api/v1/chat/sessions/{session_id}/messages`（支持附件；Body 可含 `personalization: true|false` 会话级开关）→ `{ message_id, response }`
  - `GET /api/v1/chat/sessions/{session_id}/messages` → 历史消息分页
  - `DELETE /api/v1/chat/sessions/{session_id}`
- 对话（WebSocket）
  - `ws://.../ws/chat/{session_id}`，消息分片 `chunk/complete` 流式返回
- 可视化消息协议（在消息中）：
```json
{ "type": "chart", "lib": "plotly", "payload": { /* figure JSON */ }, "meta": { "title": "..." } }
```
- 回测服务（REST）
  - `POST /api/v1/backtest/start`  
    Body：`{ symbols, start, end, cash, exec_rule, fast_mode }` → `{ job_id }`
  - `GET /api/v1/backtest/status/{job_id}` → `{ status, progress: { percent, stage } }`
  - `GET /api/v1/backtest/result/{job_id}` → `{ metrics, equity, trades, artifacts }`
  - 可选 `ws://.../ws/backtest/{job_id}` 推送进度
- 个性化/画像（REST）
  - `GET /api/v1/users/{user_id}/personalization` → `{ enabled: boolean }`
  - `PUT /api/v1/users/{user_id}/personalization`（更新全局单一开关）→ `{ enabled: boolean }`
  - `GET /api/v1/users/{user_id}/profile` → 偏好/习惯/绩效摘要
  - `GET /api/v1/users/{user_id}/activities?limit=100` → 最近行为摘要
  - `GET /api/v1/users/{user_id}/backtests?limit=20` → 最近回测摘要
  - `GET /api/v1/users/{user_id}/sim-trades?limit=100` → 最近模拟交易

### 4.4 对话上下文注入器
- 入口：对话请求进入时，构造系统级上下文（画像摘要 + 最近行为/回测/持仓片段）。
- 策略：默认注入“摘要”；细节通过工具函数按需拉取；缓存 1h；尊重隐私开关。

### 4.5 技术栈与模块映射（前后端）

- 前端·对话与可视化（Streamlit 形态）
  - 技术：Python 3.10+、Streamlit ≥1.28、Plotly ≥5、pandas、numpy、streamlit-cookies-manager
  - 责任：聊天 UI、消息渲染（text/chart/table/code/image）、本会话个性化开关、图表渲染（K 线/指标/净值曲线）、下载导出
  - 通信：REST（requests/httpx）、WebSocket（前端 JS 组件或库）

- 前端·对话与可视化（Vue 组合架构）
  - 技术：Vue 3、Vite、TypeScript、Pinia、Axios、Plotly.js 或 ECharts、原生 WebSocket API
  - 责任：同上；通过 Nginx 反代统一入口 `/` 与 `/api`

- API 网关与会话/对话服务（后端）
  - 技术：FastAPI、Uvicorn、Pydantic v2、Starlette WebSocket、JWT（python-jose 或自带认证模块）、CORS 中间件
  - 责任：会话管理、消息路由、流式分片、鉴权与限流、错误码与重试

- 对话管理与 Agent 编排
  - 技术：LangChain、LangGraph（可选）、自研 Orchestrator、LLM 适配器（OpenAI/DeepSeek/通义/Gemini）、httpx
  - 责任：意图识别、上下文抽取、工具调用、答案聚合；LLM 不可用时的降级

- 回测服务（内置引擎）
  - 技术：pandas、numpy、akshare/tushare/baostock（多源回退）、rqdatac（可选）、自研 backtest 模块
  - 任务：FastAPI BackgroundTasks（默认）或 Celery + Redis（生产建议）
  - 产物：CSV（equity/trades）、JSON（metrics）、Markdown（report）

- 数据与缓存
  - MongoDB 4.4（会话/画像/回测任务与指标/模拟交易）
  - Redis 7（会话上下文缓存、热点行情、限流/队列）
  - 客户端：motor/pymongo、redis-py

- 个性化与日志
  - 行为日志：JSONL（文件）+ 聚合入 MongoDB；APScheduler 定时任务或独立 ETL
  - 画像注入：按 personalization.enabled 单一开关控制注入；无细粒度授权

- 导出与报告
  - Pandoc（Markdown → PDF/HTML，可选）、kaleido（Plotly 静态图导出）

- 部署与运维
  - Dockerfile（Python 3.10-slim + Xvfb）、Docker Compose、Nginx 反代
  - 监控（可选）：Prometheus Exporter、Grafana、Sentry

- 日志与追踪
  - Python logging / rich、tradingagents.utils.logging_manager；关联 ID（session_id/job_id）贯穿

---

## 5. 里程碑与验收

### 5.1 里程碑（MVP → 迭代）
1. MVP（2–3 周）
   - 对话 UI + chart 消息渲染（K 线/净值曲线）
   - 回测启动/状态/结果 API + 对话内结果卡片
   - 画像注入器（摘要级）与隐私开关
2. 迭代 1（2 周）
   - 多策略对比视图与报告导出增强
   - 图表交互增强（指标勾选/快捷区间/副图）
   - 行为日志 → 画像聚合作业 + 画像 API 完整化
3. 迭代 2（2 周）
   - LLM 信号接入与对比
   - 团队协作与快照分享

### 5.2 验收标准（本期）
- 对话内可视化：`type=chart` K 线/净值曲线可交互渲染，弱网时自动降级静态图；可导出。
- 策略回测：提交 30s 内看到进度；完成后展示指标卡、净值曲线、文件下载链接；快速/LLM 两模式可运行（LLM 可后置）。
- 个性化：画像摘要成功注入；同一问题在画像不同用户上输出存在合理差异（建议/风险提示不同）。

---

## 6. 依赖与风险
- 外部依赖：数据源（Tushare/AKShare/…）、LLM 服务（DeepSeek/通义/Gemini/OpenAI）、Mongo/Redis。
- 主要风险：
  - 数据/服务不稳定 → 多源降级与重试，缓存兜底。
  - 回测耗时/资源 → 异步队列与并发限流，产物复用。
  - 隐私与成本 → 画像开关与按需拉取（降低 token 成本）。

---

## 7. 术语
- Chart 消息：对话中传输的图表消息（lib + payload + meta）。
- 快速信号：不依赖 LLM 的内置 MA 信号，用于快速回测验证。
- 画像注入器：在每次对话前，注入用户画像/行为/回测/持仓的摘要上下文组件。
